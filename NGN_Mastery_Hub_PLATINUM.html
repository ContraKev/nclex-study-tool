<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGN MASTERY HUB: PLATINUM EDITION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --secondary: #1e293b; --accent: #3b82f6; --text: #f8fafc; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --chart-bg: #f8fafc; }
        body { background-color: var(--primary); color: var(--text); font-family: 'Inter', system-ui, sans-serif; overflow-x: hidden; }
        .nexus-nav { background: var(--secondary); border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 1000; }
        .nexus-card { background: var(--secondary); border: 1px solid #334155; border-radius: 12px; padding: 25px; margin-bottom: 20px; height: 100%; transition: 0.3s; }
        .nexus-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .point-label { font-weight: 800; color: var(--accent); text-transform: uppercase; font-size: 0.7rem; margin-top: 10px; display: block; }
        .point-value { font-size: 0.95rem; color: #cbd5e1; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .badge-cv { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; }
        .badge-dm { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }
        .chart-tab-content { background: var(--chart-bg); color: #0f172a; padding: 20px; border-radius: 0 0 8px 8px; border: 1px solid #cbd5e1; min-height: 200px; font-family: 'Segoe UI', sans-serif; white-space: pre-line; }
        .chart-nav .nav-link { background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; margin-right: 2px; font-weight: 600; }
        .chart-nav .nav-link.active { background: var(--chart-bg); color: var(--primary); border-bottom-color: transparent; }
        .inter-box { margin-top: 5px; padding: 8px; border-radius: 6px; border: 1px solid #475569; font-size: 0.85rem; background: rgba(0,0,0,0.2); }
        .inter-high { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); color: #fca5a5; }
        .sidebar { height: calc(100vh - 100px); overflow-y: auto; border-right: 1px solid #334155; padding-right: 10px; }
        .module-header { background: #334155; color: var(--warning); padding: 10px 15px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; margin-top: 20px; border-radius: 6px; letter-spacing: 1px; }
        .scenario-active { border-left: 5px solid var(--accent) !important; background: rgba(59, 130, 246, 0.1) !important; color: white !important; }
        .flashcard-q { font-size: 1.4rem; font-weight: 700; color: var(--warning); margin-bottom: 25px; line-height: 1.4; }
        .rationale-text { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 1rem; color: #cbd5e1; line-height: 1.6; }
        .bowtie-col { border: 1px solid #475569; border-radius: 8px; padding: 15px; background: rgba(0,0,0,0.2); min-height: 250px; }
        .bowtie-header { text-align: center; font-weight: bold; color: var(--accent); margin-bottom: 15px; text-transform: uppercase; font-size: 0.8rem; }
    </style>
</head>
<body>

<nav class="nexus-nav py-3 mb-4 shadow">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold"><i class="fas fa-dna text-danger me-2"></i>NGN PLATINUM</h4>
        <div class="btn-group">
            <button class="btn btn-outline-light active px-4" onclick="switchTab('drugs')"><i class="fas fa-pills me-2"></i>Drugs (58)</button>
            <button class="btn btn-outline-light px-4" onclick="switchTab('scenarios')"><i class="fas fa-user-md me-2"></i>Missions (28)</button>
            <button class="btn btn-outline-light px-4" onclick="switchTab('assessments')"><i class="fas fa-graduation-cap me-2"></i>Exam (38)</button>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">

    <!-- DRUG COMPENDIUM TAB -->
    <div id="tab-drugs" class="tab-view">
        <div class="row mb-4 align-items-center bg-secondary p-3 rounded shadow-sm mx-0">
            <div class="col-md-4"><input type="text" id="drugSearch" class="form-control bg-dark text-white border-0" placeholder="Search drug name, class, or adverse effect..." onkeyup="filterDrugs()"></div>
            <div class="col-md-5">
                <div class="btn-group w-100">
                    <button class="btn btn-primary" onclick="filterDrugs('cv')">Cardio Only</button>
                    <button class="btn btn-success" onclick="filterDrugs('dm')">Diabetes Only</button>
                    <button class="btn btn-warning" onclick="filterDrugs('')">Show All</button>
                </div>
            </div>
            <div class="col-md-3 text-end">
                <button class="btn btn-dark" onclick="sortDrugs('az')"><i class="fas fa-sort-alpha-down me-2"></i>Sort A-Z</button>
            </div>
        </div>
        <div class="row" id="drug-grid"></div>
    </div>

    <!-- SCENARIO MISSIONS TAB -->
    <div id="tab-scenarios" class="tab-view" style="display: none;">
        <div class="row">
            <div class="col-md-3 sidebar">
                <div id="mission-list" class="list-group"></div>
            </div>
            <div class="col-md-9 ps-4">
                <div id="mission-arena" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 id="m-title" class="text-primary fw-bold"></h2>
                        <div class="h4">Score: <span id="m-score" class="text-success fw-bold">0</span></div>
                    </div>
                    
                    <div class="mb-4">
                        <nav class="nav nav-tabs chart-nav">
                            <button class="nav-link active" onclick="showChartTab('vitals')">Vitals</button>
                            <button class="nav-link" onclick="showChartTab('labs')">Labs</button>
                            <button class="nav-link" onclick="showChartTab('notes')">Progress Notes</button>
                            <button class="nav-link" onclick="showChartTab('mar')">MAR (Orders)</button>
                        </nav>
                        <div class="chart-tab-content shadow-sm" id="chart-box"></div>
                    </div>

                    <div class="nexus-card">
                        <div id="m-desc" class="fs-5 mb-4 pb-3 border-bottom border-secondary"></div>
                        
                        <!-- Dynamic Question Area -->
                        <div id="m-question-area"></div>
                        
                        <!-- Bowtie Area (Hidden by default) -->
                        <div id="bowtie-area" style="display: none;" class="row g-3">
                            <div class="col-md-4"><div class="bowtie-col" id="bt-actions"><div class="bowtie-header">Actions to Take (Select 2)</div></div></div>
                            <div class="col-md-4"><div class="bowtie-col" id="bt-condition"><div class="bowtie-header">Potential Condition (Select 1)</div></div></div>
                            <div class="col-md-4"><div class="bowtie-col" id="bt-params"><div class="bowtie-header">Parameters to Monitor (Select 2)</div></div></div>
                        </div>

                        <div id="m-feedback" class="mt-4" style="display: none;"></div>
                        <button id="m-next-btn" class="btn btn-primary w-100 mt-4 py-3 fw-bold shadow" style="display: none;" onclick="nextMissionStep()">CONTINUE MISSION</button>
                    </div>
                </div>
                <div id="mission-placeholder" class="text-center py-5 opacity-25">
                    <i class="fas fa-user-md fa-6x mb-4"></i>
                    <h3>Select a Clinical Case to Open Chart</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- LECTURE EXAM TAB -->
    <div id="tab-assessments" class="tab-view" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-9">
                <div class="nexus-card p-5 shadow-lg">
                    <div class="d-flex justify-content-between mb-4 border-bottom border-secondary pb-3">
                        <h5 id="ex-counter" class="text-secondary fw-bold"></h5>
                        <h5 id="ex-score" class="text-success fw-bold">Score: 0</h5>
                    </div>
                    <div id="ex-content"></div>
                    <div id="ex-feedback" class="mt-4" style="display: none;"></div>
                    <button id="ex-next-btn" class="btn btn-warning w-100 mt-4 py-3 fw-bold text-dark" style="display: none;" onclick="nextExamQ()">NEXT QUESTION</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// --- 58 DRUG COMPENDIUM (VERIFIED JSON STRUCTURE) ---
const drugDB = [
    { g: "Atorvastatin", b: "Lipitor", c: "Statin", m: "HMG-CoA Reductase Inhibitor", i: "Hyperlipidemia, CVD Prevention", con: "Active Liver Disease, Pregnancy (X)", a: "Rhabdomyolysis, Hepatotoxicity", e: "Evening dosing. Report muscle pain.", cat: "cv", inter: [{d: "Grapefruit", m: "Avoid; toxic levels.", s: "high"}] },
    { g: "Simvastatin", b: "Zocor", c: "Statin", m: "Inhibits cholesterol synthesis", i: "Hyperlipidemia", con: "Liver disease", a: "Myalgia", e: "Take in EVENING.", cat: "cv", inter: [{d: "Warfarin", m: "Monitor INR.", s: "med"}] },
    { g: "Lovastatin", b: "Mevacor", c: "Statin", m: "HMG-CoA Inhibitor", i: "Hyperlipidemia", con: "Pregnancy", a: "Muscle pain", e: "Take with food.", cat: "cv", inter: [] },
    { g: "Pravastatin", b: "Pravachol", c: "Statin", m: "HMG-CoA Inhibitor", i: "Hyperlipidemia", con: "Liver disease", a: "Myalgia", e: "Evening dose.", cat: "cv", inter: [] },
    { g: "Rosuvastatin", b: "Crestor", c: "Statin", m: "Potent HMG-CoA Inhibitor", i: "Hyperlipidemia", con: "Liver disease", a: "Rhabdomyolysis risk", e: "Report dark urine.", cat: "cv", inter: [] },
    { g: "Fluvastatin", b: "Lescol", c: "Statin", m: "HMG-CoA Inhibitor", i: "Hyperlipidemia", con: "Liver disease", a: "Myalgia", e: "Evening dose.", cat: "cv", inter: [] },
    { g: "Ezetimibe", b: "Zetia", c: "Absorption Inhibitor", m: "Blocks intestinal cholesterol absorption", i: "Hyperlipidemia", con: "Liver disease", a: "Fatigue, GI upset", e: "Low fat diet.", cat: "cv", inter: [{d: "Resins", m: "Separate by 2-4h", s: "med"}] },
    { g: "Cholestyramine", b: "Questran", c: "Bile Acid Resin", m: "Binds bile in gut", i: "Hyperlipidemia", con: "Biliary obstruction", a: "Constipation", e: "Mix with juice.", cat: "cv", inter: [{d: "All Meds", m: "Take 1h before/4h after.", s: "high"}] },
    { g: "Colesevelam", b: "Welchol", c: "Bile Acid Resin", m: "Binds bile", i: "Hyperlipidemia", con: "Bowel obstruction", a: "Constipation", e: "Take with food.", cat: "cv", inter: [{d: "All Meds", m: "Separate dosing.", s: "high"}] },
    { g: "Gemfibrozil", b: "Lopid", c: "Fibrate", m: "Induces lipid metabolism", i: "High Triglycerides", con: "Gallbladder disease", a: "Gallstones", e: "30 min before meals.", cat: "cv", inter: [{d: "Statins", m: "Rhabdo risk.", s: "high"}, {d: "Warfarin", m: "Bleeding risk.", s: "high"}] },
    { g: "Fenofibrate", b: "Tricor", c: "Fibrate", m: "Lowers TG", i: "High TG", con: "Renal disease", a: "Gallstones", e: "Take with meals.", cat: "cv", inter: [] },
    { g: "Niacin", b: "Niaspan", c: "Vitamin B3", m: "Reduces liver fat production", i: "High TG", con: "Gout, Ulcer", a: "Flushing", e: "Aspirin 30m before.", cat: "cv", inter: [] },
    { g: "Omega-3", b: "Lovaza", c: "Fish Oil", m: "Reduces TG secretion", i: "Severe High TG", con: "Fish allergy", a: "Fishy taste", e: "May inc bleeding.", cat: "cv", inter: [] },
    { g: "Alirocumab", b: "Praluent", c: "PCSK9 Inhibitor", m: "Inc LDL receptors", i: "High LDL", con: "Hypersensitivity", a: "Inj site reaction", e: "SC injection.", cat: "cv", inter: [] },
    { g: "Bempedoic acid", b: "Nexletol", c: "ACL Inhibitor", m: "Inhibits liver synth", i: "Statin intolerance", con: "Hypersensitivity", a: "Gout, Tendon rupture", e: "Report joint pain.", cat: "cv", inter: [] },
    
    // HYPERTENSION (17)
    { g: "Lisinopril", b: "Prinivil", c: "ACE-I", m: "Blocks Angiotensin I-II", i: "HTN, HF", con: "Pregnancy", a: "Cough, Angioedema", e: "Avoid K+ salt.", cat: "cv", inter: [{d: "Spironolactone", m: "Hyperkalemia risk.", s: "high"}] },
    { g: "Captopril", b: "Capoten", c: "ACE-I", m: "Blocks Angiotensin I-II", i: "HTN, HF", con: "Pregnancy", a: "Neutropenia", e: "Empty stomach.", cat: "cv", inter: [] },
    { g: "Enalapril", b: "Vasotec", c: "ACE-I", m: "Blocks Angiotensin I-II", i: "HTN, HF", con: "Pregnancy", a: "Cough", e: "Change positions slow.", cat: "cv", inter: [] },
    { g: "Ramipril", b: "Altace", c: "ACE-I", m: "Blocks Angiotensin I-II", i: "HTN", con: "Pregnancy", a: "Hyperkalemia", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Benazepril", b: "Lotensin", c: "ACE-I", m: "Blocks Angiotensin I-II", i: "HTN", con: "Pregnancy", a: "Cough", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Fosinopril", b: "Monopril", c: "ACE-I", m: "Blocks Angiotensin I-II", i: "HTN", con: "Pregnancy", a: "Cough", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Losartan", b: "Cozaar", c: "ARB", m: "Blocks Angio II Receptor", i: "HTN, HF", con: "Pregnancy", a: "Hyperkalemia", e: "Notify if pregnant.", cat: "cv", inter: [] },
    { g: "Valsartan", b: "Diovan", c: "ARB", m: "Blocks Angio II Receptor", i: "HTN, HF", con: "Pregnancy", a: "Dizziness", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Candesartan", b: "Atacand", c: "ARB", m: "Blocks Angio II Receptor", i: "HTN, HF", con: "Pregnancy", a: "Hyperkalemia", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Aliskiren", b: "Tekturna", c: "Renin Inhibitor", m: "Blocks Renin", i: "HTN", con: "Diabetes (w/ ACE)", a: "Angioedema", e: "Avoid high fat.", cat: "cv", inter: [] },
    { g: "Amlodipine", b: "Norvasc", c: "CCB (DHP)", m: "Ca+ Blockade (Vessels)", i: "HTN, Angina", con: "Heart Block", a: "Edema", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Nifedipine", b: "Procardia", c: "CCB (DHP)", m: "Ca+ Blockade (Vessels)", i: "HTN, Angina", con: "Heart Block", a: "Reflex Tachycardia", e: "Check BP.", cat: "cv", inter: [] },
    { g: "Verapamil", b: "Calan", c: "CCB (Non-DHP)", m: "Ca+ Blockade (Heart)", i: "AFib, Angina", con: "HF", a: "Constipation", e: "High fiber.", cat: "cv", inter: [{d: "Digoxin", m: "Increases Digoxin level.", s: "high"}] },
    { g: "Diltiazem", b: "Cardizem", c: "CCB (Non-DHP)", m: "Ca+ Blockade (Heart)", i: "AFib, Angina", con: "HF", a: "Bradycardia", e: "Check Pulse.", cat: "cv", inter: [] },
    { g: "Metoprolol", b: "Lopressor", c: "Beta-1 Selective", m: "Reduces HR/Contractility", i: "HTN, HF", con: "Bradycardia", a: "Fatigue", e: "Hold HR < 60.", cat: "cv", inter: [{d: "Insulin", m: "Masks hypoglycemia.", s: "high"}] },
    { g: "Atenolol", b: "Tenormin", c: "Beta-1 Selective", m: "Reduces HR", i: "HTN, Angina", con: "Bradycardia", a: "Fatigue", e: "Check Pulse.", cat: "cv", inter: [] },
    { g: "Propranolol", b: "Inderal", c: "Non-Selective Beta", m: "Blocks B1/B2", i: "Anxiety, HTN", con: "Asthma", a: "Bronchospasm", e: "Danger in Asthma.", cat: "cv", inter: [{d: "Albuterol", m: "Blocks effect.", s: "high"}] },
    
    // --- OTHER CV (16) ---
    { g: "Carvedilol", b: "Coreg", c: "Alpha/Beta Blocker", m: "Vasodilation", i: "HF", con: "Severe HF", a: "Bradycardia", e: "Take with food.", cat: "cv", inter: [] },
    { g: "Labetalol", b: "Trandate", c: "Alpha/Beta Blocker", m: "Vasodilation", i: "HTN Crisis", con: "Asthma", a: "Orthostatic Hypo", e: "Rise slowly.", cat: "cv", inter: [] },
    { g: "Prazosin", b: "Minipress", c: "Alpha-1 Blocker", m: "Vasodilation", i: "HTN, BPH", con: "Hypersensitivity", a: "Syncope", e: "1st dose at bed.", cat: "cv", inter: [] },
    { g: "Clonidine", b: "Catapres", c: "Alpha-2 Agonist", m: "Central acting", i: "HTN", con: "Hypersensitivity", a: "Dry mouth", e: "Don't stop abruptly.", cat: "cv", inter: [] },
    { g: "Methyldopa", b: "Aldomet", c: "Alpha-2 Agonist", m: "Central acting", i: "Pregnancy HTN", con: "Liver disease", a: "Sedation", e: "Safe in pregnancy.", cat: "cv", inter: [] },
    { g: "Hydralazine", b: "Apresoline", c: "Vasodilator", m: "Direct relaxation", i: "HTN", con: "CAD", a: "Reflex Tachycardia", e: "Monitor HR.", cat: "cv", inter: [] },
    { g: "Nitroprusside", b: "Nitropress", c: "Vasodilator", m: "Potent dilation", i: "HTN Crisis", con: "HF", a: "Cyanide Toxicity", e: "IV only.", cat: "cv", inter: [] },
    { g: "Digoxin", b: "Lanoxin", c: "Glycoside", m: "Inotropic", i: "HF, AFib", con: "Heart Block", a: "Halos, Toxicity", e: "Pulse 1 min.", cat: "cv", inter: [{d: "Furosemide", m: "Low K+ risk.", s: "critical"}] },
    { g: "Nitroglycerin", b: "Nitrostat", c: "Nitrate", m: "Vasodilation", i: "Angina", con: "Viagra", a: "Headache", e: "Free period 8-12h.", cat: "cv", inter: [{d: "Sildenafil", m: "Fatal BP drop.", s: "critical"}] },
    { g: "Furosemide", b: "Lasix", c: "Loop Diuretic", m: "Blocks Loop", i: "HF, Edema", con: "Anuria", a: "Ototoxicity", e: "Take AM.", cat: "cv", inter: [] },
    { g: "HCTZ", b: "Microzide", c: "Thiazide", m: "Distal tubule", i: "HTN", con: "Renal fail", a: "Hypercalcemia", e: "Take AM.", cat: "cv", inter: [] },
    { g: "Spironolactone", b: "Aldactone", c: "K-Sparing", m: "Aldosterone Antag", i: "HF, HTN", con: "Hyperkalemia", a: "Gynecomastia", e: "Avoid K+.", cat: "cv", inter: [] },
    { g: "Warfarin", b: "Coumadin", c: "Anticoagulant", m: "Vit K Antagonist", i: "VTE", con: "Bleeding", a: "Bleeding", e: "Consistent Vit K.", cat: "cv", inter: [{d: "Antibiotics", m: "Check INR.", s: "high"}] },
    { g: "Heparin", b: "Hep-Lock", c: "Anticoagulant", m: "Thrombin Inhib", i: "DVT/PE", con: "HIT", a: "Bleeding", e: "Monitor aPTT.", cat: "cv", inter: [] },
    { g: "Enoxaparin", b: "Lovenox", c: "LMWH", m: "Factor Xa", i: "DVT prophylaxis", con: "Bleeding", a: "Bleeding", e: "SQ only.", cat: "cv", inter: [] },
    { g: "Amiodarone", b: "Cordarone", c: "Antiarrhythmic", m: "K+ Channel", i: "VT/VF", con: "Heart block", a: "Blue skin", e: "Report SOB.", cat: "cv", inter: [] },

    // --- DIABETES (10) ---
    { g: "Metformin", b: "Glucophage", c: "Biguanide", m: "Liver glucose reduction", i: "T2DM", con: "Renal fail", a: "Lactic Acidosis", e: "Hold for dye.", cat: "dm", inter: [{d: "Contrast", m: "Hold 48h.", s: "critical"}] },
    { g: "Glipizide", b: "Glucotrol", c: "Sulfonylurea", m: "Insulin release", i: "T2DM", con: "Sulfa allergy", a: "Hypoglycemia", e: "30 min before meal.", cat: "dm", inter: [{d: "Alcohol", m: "Disulfiram rxn.", s: "high"}] },
    { g: "Repaglinide", b: "Prandin", c: "Meglitinide", m: "Fast insulin release", i: "T2DM", con: "DKA", a: "Hypoglycemia", e: "Skip meal=skip dose.", cat: "dm", inter: [] },
    { g: "Pioglitazone", b: "Actos", c: "TZD", m: "Insulin sensitivity", i: "T2DM", con: "Heart Failure", a: "Edema", e: "Report weight gain.", cat: "dm", inter: [] },
    { g: "Acarbose", b: "Precose", c: "Alpha-Gluc", m: "Carb absorption", i: "T2DM", con: "IBD", a: "Gas", e: "First bite.", cat: "dm", inter: [] },
    { g: "Canagliflozin", b: "Invokana", c: "SGLT2", m: "Renal glucose excretion", i: "T2DM", con: "Dialysis", a: "UTI/Yeast", e: "Hydration.", cat: "dm", inter: [] },
    { g: "Sitagliptin", b: "Januvia", c: "DPP-4", m: "Incretin enhancer", i: "T2DM", con: "Renal", a: "Pancreatitis", e: "Report abd pain.", cat: "dm", inter: [] },
    { g: "Semaglutide", b: "Ozempic", c: "GLP-1", m: "Incretin mimetic", i: "T2DM", con: "Thyroid Ca", a: "Pancreatitis", e: "Weekly SC.", cat: "dm", inter: [] },
    { g: "Pramlintide", b: "Symlin", c: "Amylin", m: "Slows gastric", i: "T1/T2", con: "Gastroparesis", a: "Severe Hypo", e: "Before meals.", cat: "dm", inter: [] },
    { g: "Regular Insulin", b: "Humulin R", c: "Short", m: "Glucose uptake", i: "DKA", con: "Hypo", a: "Hypo", e: "IV use.", cat: "dm", inter: [] }
];

// --- 28 MISSIONS WITH CHART DATA ---
const missionDB = [
    { mod: 1, id: "m1", title: "Handover: Confusion", charts: { vitals: "BP 110/70 | SpO2 89% | HR 82", labs: "WBC 8.5 | Hgb 14.2", notes: "AO1 (Baseline AO3). 2L NC placed.", mar: "Lisinopril 10mg" }, steps: [{ d: "Confused patient Henderson.", q: "First priority?", o: ["Assess patient", "Chart check", "Breakroom"], c: 0, r: "Assess unstable patient first." }]},
    { mod: 2, id: "m2", title: "Assessment: PAD", charts: { vitals: "BP 140/90", labs: "LDL 180", notes: "Legs cool, hairless. Pulses absent.", mar: "Atorvastatin 40mg" }, steps: [{ d: "Cool skin, hairless legs.", q: "Finding?", o: ["PAD", "Venous Insufficiency"], c: 0, r: "Arterial findings = PAD." }]},
    { mod: 3, id: "m3", title: "Crisis: Digoxin", charts: { vitals: "HR 48 | BP 102/60", labs: "K+ 3.1 | Digoxin 2.6", notes: "Yellow halos.", mar: "Digoxin, Lasix" }, steps: [{ d: "Visual disturbances.", q: "Identify cause.", o: ["Digoxin Toxicity", "HTN Crisis"], c: 0, r: "Low K+ triggered toxicity." }]},
    { mod: 4, id: "m4", title: "NGN Bowtie: HF", charts: { vitals: "BP 162/98 | RR 24", labs: "K+ 3.1", notes: "3+ Pitting edema. SOB.", mar: "Digoxin, Lasix" }, type: "bowtie", steps: [{ d: "BOWTIE ANALYSIS", q: "Complete the diagram.", o: ["(Use Chart Tabs)"], c: 0, r: "Preload crisis requiring K+." }]},
    { mod: 3, id: "m5", title: "Statin Teaching", charts: { vitals: "WNL", labs: "LDL 190", notes: "Starting Simvastatin.", mar: "Simvastatin 20mg" }, steps: [{ d: "Discharge teaching.", q: "When to take?", o: ["Evening", "Morning"], c: 0, r: "Cholesterol synth peaks at night." }]},
    { mod: 3, id: "m6", title: "Gemfibrozil", charts: { vitals: "WNL", labs: "TG 500", notes: "GI complaints.", mar: "Gemfibrozil" }, steps: [{ d: "Patient reports diarrhea.", q: "Significance?", o: ["Common side effect", "Emergency"], c: 0, r: "GI distress is common." }]},
    { mod: 3, id: "m7", title: "Furosemide IV", charts: { vitals: "BP 150/90", labs: "K+ 3.8", notes: "Edema +2. Order: Lasix 40mg IVP.", mar: "Lasix" }, steps: [{ d: "Administering IV push.", q: "Safety check?", o: ["Push slow (Ototoxicity)", "Push fast"], c: 0, r: "Prevent hearing loss." }]},
    { mod: 3, id: "m8", title: "HCTZ Teaching", charts: { vitals: "BP 130/85", labs: "Na 138", notes: "New script.", mar: "HCTZ 25mg" }, steps: [{ d: "Teaching plan.", q: "Take with?", o: ["Food", "Empty stomach"], c: 0, r: "Reduces GI upset." }]},
    { mod: 3, id: "m9", title: "Spironolactone", charts: { vitals: "BP 120/80", labs: "K+ 5.4", notes: "Muscle weakness.", mar: "Aldactone" }, steps: [{ d: "Lab review.", q: "Action?", o: ["Hold & Notify", "Give dose"], c: 0, r: "Hyperkalemia > 5.0." }]},
    { mod: 3, id: "m10", title: "Torsemide", charts: { vitals: "BP 90/60", labs: "K+ 3.2", notes: "Dizzy.", mar: "Torsemide" }, steps: [{ d: "Assessment.", q: "Monitor for?", o: ["Hypotension/Hypokalemia", "HTN"], c: 0, r: "Loop diuretic effects." }]},
    { mod: 3, id: "m11", title: "Lasix Elderly", charts: { vitals: "HR 90", labs: "K+ 3.0", notes: "Confused, weak.", mar: "Lasix" }, steps: [{ d: "Symptoms.", q: "Diet teaching?", o: ["Increase K+", "Restrict K+"], c: 0, r: "Hypokalemia signs." }]},
    { mod: 3, id: "m12", title: "Hypoglycemia", charts: { vitals: "HR 110", labs: "BG 55", notes: "Tremors.", mar: "Atenolol, Insulin" }, steps: [{ d: "Drug cause?", q: "Which masks symptoms?", o: ["Atenolol", "Lisinopril"], c: 0, r: "Beta blockers mask tachycardia." }]},
    { mod: 3, id: "m13", title: "Lisinopril", charts: { vitals: "BP 130/80", labs: "HCG Positive", notes: "Young female.", mar: "Lisinopril" }, steps: [{ d: "Pregnancy test.", q: "Action?", o: ["Notify MD/Stop", "Continue"], c: 0, r: "Teratogenic." }]},
    { mod: 3, id: "m14", title: "Propranolol", charts: { vitals: "HR 70", labs: "WNL", notes: "History: Asthma.", mar: "Propranolol" }, steps: [{ d: "History check.", q: "Concern?", o: ["Bronchospasm", "Sedation"], c: 0, r: "Non-selective blocks B2." }]},
    { mod: 3, id: "m15", title: "Captopril", charts: { vitals: "BP 140/90", labs: "K+ 5.1", notes: "New script.", mar: "Captopril" }, steps: [{ d: "Adverse effect?", q: "Monitor?", o: ["Hyperkalemia", "Hypokalemia"], c: 0, r: "ACE-I retain K+." }]},
    { mod: 3, id: "m16", title: "NTG Headache", charts: { vitals: "BP 110/70", labs: "WNL", notes: "Taken SL NTG.", mar: "Nitro" }, steps: [{ d: "Reports headache.", q: "Response?", o: ["Expected side effect", "Allergy"], c: 0, r: "Vasodilation causes headache." }]},
    { mod: 3, id: "m17", title: "NTG Pain", charts: { vitals: "HR 100", labs: "WNL", notes: "Pain 5 min after 1st pill.", mar: "Nitro" }, steps: [{ d: "Pain persists.", q: "Action?", o: ["Call 911", "Wait"], c: 0, r: "Emergency protocol." }]},
    { mod: 3, id: "m18", title: "Verapamil", charts: { vitals: "HR 60", labs: "WNL", notes: "Constipation.", mar: "Verapamil" }, steps: [{ d: "Discharge.", q: "Teach?", o: ["Monitor Pulse", "Take with grapefruit"], c: 0, r: "Bradycardia risk." }]},
    { mod: 3, id: "m19", title: "Digoxin Signs", charts: { vitals: "HR 50", labs: "Dig 2.2", notes: "Nauseous.", mar: "Digoxin" }, steps: [{ d: "Toxicity signs.", q: "Report?", o: ["Halos/Fatigue", "Cough"], c: 0, r: "CNS/Visual effects." }]},
    { mod: 3, id: "m20", title: "Digoxin Risk", charts: { vitals: "WNL", labs: "K+ 3.2", notes: "On Lasix.", mar: "Digoxin" }, steps: [{ d: "Risk factor?", q: "Highest risk?", o: ["Pt on Lasix", "Pt on ACE"], c: 0, r: "Hypokalemia precipitates toxicity." }]},
    { mod: 3, id: "m21", title: "Heparin SQ", charts: { vitals: "WNL", labs: "Plt 200", notes: "DVT prophylaxis.", mar: "Heparin" }, steps: [{ d: "Teaching.", q: "Toothbrush?", o: ["Soft", "Hard"], c: 0, r: "Bleeding risk." }]},
    { mod: 3, id: "m22", title: "Heparin Admin", charts: { vitals: "WNL", labs: "WNL", notes: "Administering.", mar: "Heparin" }, steps: [{ d: "Technique.", q: "Angle?", o: ["90 degrees", "45 degrees"], c: 0, r: "SQ injection." }]},
    { mod: 3, id: "m23", title: "Warfarin INR", charts: { vitals: "WNL", labs: "INR 2.5", notes: "Clinic visit.", mar: "Warfarin" }, steps: [{ d: "Patient asks about test.", q: "Why INR?", o: ["Standardized result", "Faster"], c: 0, r: "Consistent across labs." }]},
    { mod: 3, id: "m24", title: "Metformin XR", charts: { vitals: "WNL", labs: "Cr 0.8", notes: "GI upset hx.", mar: "Glucophage XR" }, steps: [{ d: "Dosing.", q: "Take when?", o: ["With meal", "Empty stomach"], c: 0, r: "Reduces nausea." }]},
    { mod: 3, id: "m25", title: "Glipizide", charts: { vitals: "WNL", labs: "BG 110", notes: "New script.", mar: "Glipizide" }, steps: [{ d: "Mechanism.", q: "How it works?", o: ["Stimulates pancreas", "Blocks liver"], c: 0, r: "Secretagogue." }]},
    { mod: 3, id: "m26", title: "Repaglinide", charts: { vitals: "WNL", labs: "WNL", notes: "Mealtime dosing.", mar: "Prandin" }, steps: [{ d: "Timing.", q: "When?", o: ["30m before eat", "Bedtime"], c: 0, r: "Fast acting." }]},
    { mod: 3, id: "m27", title: "Acarbose", charts: { vitals: "WNL", labs: "AST/ALT elevated", notes: "Long term use.", mar: "Precose" }, steps: [{ d: "Monitoring.", q: "Lab?", o: ["LFTs", "CBC"], c: 0, r: "Hepatotoxicity." }]},
    { mod: 3, id: "m28", title: "Metformin Danger", charts: { vitals: "RR 24", labs: "pH 7.30", notes: "Sleepy.", mar: "Metformin" }, steps: [{ d: "Somnolence.", q: "Report?", o: ["Somnolence", "Cough"], c: 0, r: "Lactic acidosis sign." }]}
];

// --- EXAM (38) ---
const examDB = [
    { q: "Simvastatin Timing?", o: ["Evening", "Morning"], c: 0, r: "Cholesterol synth peak." },
    { q: "Atorvastatin Lab?", o: ["LFTs", "INR"], c: 0, r: "Liver toxicity." },
    { q: "Gemfibrozil Side Effect?", o: ["Diarrhea", "Cough"], c: 0, r: "GI distress." },
    { q: "Furosemide Priority?", o: ["Tinnitus", "Rash"], c: 0, r: "Ototoxicity." },
    { q: "HCTZ Instruction?", o: ["Take with food", "Empty stomach"], c: 0, r: "GI upset." },
    { q: "Spironolactone Report?", o: ["K+ 5.2", "K+ 4.0"], c: 0, r: "Hyperkalemia." },
    { q: "Torsemide Adverse?", o: ["Hypokalemia", "Hyperkalemia"], c: 0, r: "Wastes K+." },
    { q: "Lasix Weakness?", o: ["Eat K+ foods", "Restrict K+"], c: 0, r: "Hypokalemia signs." },
    { q: "Hypoglycemia Drug?", o: ["Atenolol", "Lisinopril"], c: 0, r: "Masking effect." },
    { q: "Lisinopril Pregnant?", o: ["Notify MD", "Safe"], c: 0, r: "Teratogenic." },
    { q: "Propranolol Contra?", o: ["Asthma", "Gout"], c: 0, r: "Bronchospasm." },
    { q: "Captopril Monitor?", o: ["Hyperkalemia", "Hypokalemia"], c: 0, r: "K+ retention." },
    { q: "NTG Headache?", o: ["Expected", "Allergy"], c: 0, r: "Vasodilation." },
    { q: "NTG Unrelieved?", o: ["Call 911", "Wait"], c: 0, r: "Emergency." },
    { q: "Verapamil Diet?", o: ["High Fiber", "Low Fiber"], c: 0, r: "Constipation." },
    { q: "Digoxin Toxicity?", o: ["Visual Halos", "Rash"], c: 0, r: "CNS signs." },
    { q: "Digoxin Risk?", o: ["Pt on Lasix", "Pt on ACE"], c: 0, r: "Low K+." },
    { q: "Metformin XR?", o: ["With meal", "Empty"], c: 0, r: "GI comfort." },
    { q: "Glipizide Action?", o: ["Pancreas stim", "Liver block"], c: 0, r: "Insulin release." },
    { q: "Repaglinide Time?", o: ["30m pre-meal", "Bedtime"], c: 0, r: "Mealtime." },
    { q: "Acarbose Lab?", o: ["LFTs", "WBC"], c: 0, r: "Liver tox." },
    { q: "Metformin Report?", o: ["Somnolence", "Hunger"], c: 0, r: "Lactic Acidosis." },
    { q: "Metformin Contra?", o: ["Prednisone", "Aspirin"], c: 0, r: "Hyperglycemia." },
    { q: "Insulin Mix?", o: ["Reg then NPH", "NPH then Reg"], c: 0, r: "Clear before cloudy." },
    { q: "Rotate Sites?", o: ["Lipohypertrophy", "Pain"], c: 0, r: "Fatty lumps." },
    { q: "Intermediate?", o: ["NPH", "Lispro"], c: 0, r: "Basal." },
    { q: "IV Insulin?", o: ["Regular", "NPH"], c: 0, r: "Only Regular." },
    { q: "DKA Tx?", o: ["Regular IV", "NPH SQ"], c: 0, r: "IV required." },
    { q: "Heparin Teach?", o: ["Soft toothbrush", "Floss hard"], c: 0, r: "Bleeding." },
    { q: "Heparin Angle?", o: ["90 deg", "45 deg"], c: 0, r: "SQ." },
    { q: "INR Info?", o: ["Standardized", "Fast"], c: 0, r: "Lab standard." },
    { q: "Warfarin Diet?", o: ["Consistent K", "No K"], c: 0, r: "INR stability." },
    { q: "Beta Blocker Mask?", o: ["Tachycardia", "Sweating"], c: 0, r: "HR masked." },
    { q: "ACE Cough?", o: ["Notify MD", "Ignore"], c: 0, r: "Switch ARB." },
    { q: "NTG Storage?", o: ["Dark bottle", "Clear bottle"], c: 0, r: "Light sensitive." },
    { q: "Digoxin Toxic?", o: [">2.4", ">1.0"], c: 0, r: "Narrow index." },
    { q: "Nitrate Tolerance?", o: ["12h free", "Continuous"], c: 0, r: "Prevent tolerance." },
    { q: "Heparin Antidote?", o: ["Protamine", "Vit K"], c: 0, r: "Reversal." }
];

// LOGIC
let activeMission = null; let mStepIdx = 0; let mScore = 0; let exIdx = 0; let exScore = 0;

function switchTab(t) {
    document.querySelectorAll('.tab-view').forEach(v => v.style.display = 'none');
    document.querySelectorAll('.nexus-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${t}`).style.display = 'block';
    if(t === 'drugs') renderDrugs();
    if(t === 'scenarios') renderMissionMenu();
    if(t === 'assessments') renderExam();
}

function renderDrugs(filter = "") {
    const grid = document.getElementById('drug-grid');
    let data = [...drugDB];
    if(filter === 'cv') data = drugDB.filter(d => d.cat === 'cv');
    if(filter === 'dm') data = drugDB.filter(d => d.cat === 'dm');
    if(filter && !['cv','dm'].includes(filter)) data = drugDB.filter(d => JSON.stringify(d).toLowerCase().includes(filter.toLowerCase()));
    
    grid.innerHTML = data.map(d => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="nexus-card">
                <div class="d-flex justify-content-between">
                    <h5 class="fw-bold text-white mb-0">${d.g} (${d.b})</h5>
                    <span class="badge ${d.cat === 'cv' ? 'badge-cv' : 'badge-dm'}">${d.c}</span>
                </div>
                <div class="point-label">Mechanism</div><div class="point-value">${d.m}</div>
                <div class="point-label">Indications</div><div class="point-value">${d.i}</div>
                <div class="point-label">Contraindications</div><div class="point-value">${d.con}</div>
                <div class="point-label">Adverse Effects</div><div class="point-value text-danger">${d.a}</div>
                <div class="point-label">Interactions</div><div class="point-value">${d.inter ? d.inter.map(i=>`${i.d}: ${i.m}`).join(', ') : 'None'}</div>
                <div class="point-label">Patient Education</div><div class="point-value text-info">${d.e}</div>
            </div>
        </div>
    `).join('');
}

function sortDrugs(t) {
    if(t === 'az') drugDB.sort((a,b) => a.g.localeCompare(b.g));
    else drugDB.sort((a,b) => a.c.localeCompare(b.c));
    renderDrugs();
}

function filterDrugs(f) { renderDrugs(f); }

function renderMissionMenu() {
    const list = document.getElementById('mission-list');
    let html = "";
    const modNames = { 1: "SNF Basics", 2: "Vascular/HTN", 3: "Pharmacology (20)", 4: "NGN Case Studies" };
    for(let m = 1; m <= 4; m++) {
        html += `<div class="module-header">Module ${m}: ${modNames[m]}</div>`;
        missionDB.filter(item => item.mod === m).forEach((item) => {
            html += `<button class="list-group-item list-group-item-action bg-transparent text-white border-secondary mb-1" onclick="startMission('${item.id}', this)">${item.title}</button>`;
        });
    }
    list.innerHTML = html;
}

function startMission(id, el) {
    document.querySelectorAll('.list-group-item').forEach(b => b.classList.remove('scenario-active'));
    el.classList.add('scenario-active');
    activeMission = missionDB.find(m => m.id === id);
    mStepIdx = 0; mScore = 0;
    document.getElementById('m-score').innerText = mScore;
    document.getElementById('mission-placeholder').style.display = 'none';
    document.getElementById('mission-arena').style.display = 'block';
    
    // Check if bowtie
    if(activeMission.type === 'bowtie') {
        document.getElementById('bowtie-area').style.display = 'flex';
        renderBowtieLogic();
    } else {
        document.getElementById('bowtie-area').style.display = 'none';
        renderMissionStep();
    }
    showChartTab('vitals');
}

function renderBowtieLogic() {
    // Basic rendering for the bowtie interaction
    document.getElementById('m-question-area').innerHTML = `<p class="text-warning">Review the charts and select the correct components below.</p>`;
    // (Simplified for this version - functional implementation would go here)
}

function showChartTab(tab) {
    const box = document.getElementById('chart-box');
    document.querySelectorAll('.chart-nav .nav-link').forEach(btn => {
        btn.classList.remove('active');
        if(btn.innerText.toLowerCase().includes(tab)) btn.classList.add('active');
    });
    box.innerText = activeMission.charts[tab] || "No clinical data in current record.";
}

function renderMissionStep() {
    const s = activeMission.steps[mStepIdx];
    document.getElementById('m-title').innerText = activeMission.title;
    document.getElementById('m-desc').innerText = s.d;
    const area = document.getElementById('m-question-area');
    area.innerHTML = `<h4 class="mb-4 text-warning">${s.q}</h4>` + s.o.map((opt, i) => `<button class="btn btn-outline-light w-100 text-start mb-2 p-3" onclick="checkStep(${i})">${opt}</button>`).join('');
    document.getElementById('m-feedback').style.display = 'none';
    document.getElementById('m-next-btn').style.display = 'none';
}

function checkStep(i) {
    const s = activeMission.steps[mStepIdx];
    const fb = document.getElementById('m-feedback');
    fb.style.display = 'block';
    if(i === s.c) { mScore += 10; fb.innerHTML = `<div class="alert alert-success">${s.r}</div>`; }
    else { mScore -= 5; fb.innerHTML = `<div class="alert alert-danger">${s.r}</div>`; }
    document.getElementById('m-score').innerText = mScore;
    document.getElementById('m-next-btn').style.display = 'block';
}

function nextMissionStep() {
    mStepIdx++;
    if(mStepIdx < activeMission.steps.length) renderMissionStep();
    else alert("Simulation Complete! Score: " + mScore);
}

function renderExam() {
    const q = examDB[exIdx];
    document.getElementById('ex-counter').innerText = `Question ${exIdx + 1} of ${examDB.length}`;
    const area = document.getElementById('ex-content');
    area.innerHTML = `<p class="flashcard-q">${q.q}</p>` + q.o.map((opt, i) => `<button class="btn btn-outline-secondary w-100 text-start mb-2 p-3" onclick="checkExam(${i})">${opt}</button>`).join('');
    document.getElementById('ex-feedback').style.display = 'none';
    document.getElementById('ex-next-btn').style.display = 'none';
}

function checkExam(i) {
    const q = examDB[exIdx];
    const fb = document.getElementById('ex-feedback');
    fb.style.display = 'block';
    if(i === q.c) { fb.innerHTML = `<div class="alert alert-success"><b>CORRECT</b><div class="rationale-text">${q.r}</div></div>`; }
    else { fb.innerHTML = `<div class="alert alert-danger"><b>INCORRECT</b><div class="rationale-text">${q.r}</div></div>`; }
    document.getElementById('ex-next-btn').style.display = 'block';
}

function nextExamQ() { exIdx = (exIdx + 1) % examDB.length; renderExam(); }

switchTab('drugs');
</script>
</body>
</html>
