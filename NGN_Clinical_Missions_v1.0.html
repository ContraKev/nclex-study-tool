<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGN CLINICAL MISSIONS v1.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --secondary: #1e293b; --accent: #3b82f6; --text: #f8fafc; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --border: #334155; --bg-chart: #f1f5f9; }
        body, html { height: 100%; margin: 0; background-color: var(--primary); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; width: 100vw; }
        .chart-pane { width: 45%; background: var(--bg-chart); color: #1e293b; border-right: 4px solid var(--border); display: flex; flex-direction: column; }
        .work-pane { width: 55%; padding: 40px; overflow-y: auto; background: var(--primary); }

        /* Chart/EHR Styles */
        .chart-header { background: #334155; color: white; padding: 15px 20px; border-bottom: 1px solid #1e293b; }
        .chart-tabs { background: #e2e8f0; display: flex; border-bottom: 1px solid #cbd5e1; }
        .chart-tab { padding: 12px 20px; cursor: pointer; border-right: 1px solid #cbd5e1; font-weight: 600; font-size: 0.85rem; color: #64748b; transition: 0.2s; }
        .chart-tab:hover { background: #f1f5f9; }
        .chart-tab.active { background: white; color: var(--accent); border-bottom: 3px solid var(--accent); }
        .chart-content { padding: 25px; flex-grow: 1; overflow-y: auto; background: white; line-height: 1.6; }

        /* Question Area */
        .step-badge { background: var(--accent); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 15px; display: inline-block; }
        .question-text { font-size: 1.4rem; font-weight: 700; margin-bottom: 25px; line-height: 1.4; }
        
        /* Matrix Grid */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .matrix-table th { color: var(--accent); font-size: 0.75rem; text-transform: uppercase; text-align: center; padding: 10px; }
        .matrix-table td { background: var(--secondary); padding: 15px; border: 1px solid var(--border); }
        .matrix-table td:first-child { border-radius: 10px 0 0 10px; font-weight: 600; width: 40%; }
        .matrix-table td:last-child { border-radius: 0 10px 10px 0; }
        .matrix-table .radio-cell { text-align: center; width: 20%; }

        /* Bowtie Diagram */
        .bowtie-container { display: flex; gap: 15px; align-items: stretch; margin-top: 20px; }
        .bowtie-wing { flex: 1; background: rgba(59, 130, 246, 0.05); border: 2px dashed var(--border); border-radius: 15px; padding: 20px; }
        .bowtie-center { width: 220px; background: rgba(245, 158, 11, 0.1); border: 2px solid var(--warning); border-radius: 15px; padding: 20px; display: flex; flex-direction: column; justify-content: center; }
        .bowtie-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; text-align: center; }

        /* Generic Components */
        .list-group-item-action { background: var(--secondary) !important; color: white !important; border: 1px solid var(--border) !important; margin-bottom: 8px; border-radius: 8px !important; }
        .list-group-item-action:hover { border-color: var(--accent) !important; }
        .feedback-box { margin-top: 25px; padding: 20px; border-radius: 12px; border-left: 6px solid; }
        .feedback-correct { background: rgba(34, 197, 94, 0.1); border-color: var(--success); }
        .feedback-incorrect { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        
        .action-btn { background: var(--warning); color: var(--primary); font-weight: 800; padding: 15px 40px; border-radius: 10px; border: none; font-size: 1.1rem; transition: 0.3s; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        table.clinical-table { width: 100%; font-size: 0.9rem; }
        table.clinical-table th { background: #f8fafc; border-bottom: 2px solid #cbd5e1; padding: 10px; }
        table.clinical-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .status-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: 800; }
        .status-critical { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- LEFT PANE: EHR CHART -->
    <div class="chart-pane">
        <div class="chart-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 fw-bold" id="patient-name">LOADING...</h5>
                <span class="small opacity-75" id="patient-meta">MRN: 0000 | AGE: 00</span>
            </div>
            <i class="fas fa-hospital-user fs-3 opacity-50"></i>
        </div>
        <div class="chart-tabs" id="exhibit-tabs">
            <!-- Tabs injected here -->
        </div>
        <div class="chart-content" id="exhibit-content">
            <!-- Content injected here -->
        </div>
    </div>

    <!-- RIGHT PANE: WORKBENCH -->
    <div class="work-pane">
        <div id="mission-ui">
            <div id="step-header"></div>
            <div id="question-container"></div>
            <div id="options-container"></div>
            <div id="feedback-area"></div>
            
            <div class="d-flex justify-content-between align-items-center mt-5">
                <div id="score-tracker" class="text-white-50 small fw-bold">STEP 1 OF 3</div>
                <button class="action-btn" id="next-btn" onclick="handleStepAction()">SUBMIT ANSWER</button>
            </div>
        </div>
    </div>
</div>

<script src="mission_prototype.js"></script>
<script>
    let currentMission = null;
    let currentStepIndex = 0;
    let feedbackMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof mission_prototype !== 'undefined') {
            loadMission(mission_prototype);
        }
    });

    function loadMission(mission) {
        currentMission = mission;
        document.getElementById('patient-name').innerText = mission.patient_profile.demographics.name;
        document.getElementById('patient-meta').innerText = `MRN: ${mission.patient_profile.demographics.mrn} | AGE: ${mission.patient_profile.demographics.age} | SEX: ${mission.patient_profile.demographics.gender}`;
        
        renderExhibits();
        renderStep();
    }

    function renderExhibits() {
        const tabs = document.getElementById('exhibit-tabs');
        const profile = currentMission.patient_profile;
        
        // Always include History as first tab
        let html = `<div class="chart-tab active" onclick="showExhibit('history', this)">History</div>`;
        
        currentMission.exhibits.forEach((ex, idx) => {
            html += `<div class="chart-tab" onclick="showExhibit(${idx}, this)">${ex.title}</div>`;
        });
        
        tabs.innerHTML = html;
        showExhibit('history');
    }

    function showExhibit(type, el) {
        if (el) {
            document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        const content = document.getElementById('exhibit-content');
        if (type === 'history') {
            const p = currentMission.patient_profile;
            content.innerHTML = `
                <h6 class="fw-bold text-primary border-bottom pb-2">Admission Summary</h6>
                <p><strong>Chief Complaint:</strong> ${p.chief_complaint}</p>
                <p><strong>HPI:</strong> ${p.hpi}</p>
                <p><strong>PMH:</strong> ${p.pmh}</p>
                <p><strong>Social History:</strong> ${p.sh}</p>
                <h6 class="fw-bold text-primary border-bottom pb-2 mt-4">Review of Systems</h6>
                <p><strong>Neuro:</strong> ${p.ros.neuro}</p>
                <p><strong>Cardio:</strong> ${p.ros.cardio}</p>
                <p><strong>GI:</strong> ${p.ros.gi}</p>
                <p><strong>GU:</strong> ${p.ros.gu}</p>
            `;
        } else {
            const ex = currentMission.exhibits[type];
            if (ex.type === 'table') {
                content.innerHTML = `
                    <h6 class="fw-bold text-primary border-bottom pb-2">${ex.title}</h6>
                    <table class="clinical-table mt-3">
                        <thead><tr>${Object.keys(ex.data[0]).map(k => `<th>${k.toUpperCase()}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${ex.data.map(row => `<tr>${Object.values(row).map(v => `<td>${v}</td>`).join('')}</tr>`).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                content.innerHTML = `
                    <h6 class="fw-bold text-primary border-bottom pb-2">${ex.title}</h6>
                    <div class="mt-3 fs-6">${ex.content}</div>
                `;
            }
        }
    }

    function renderStep() {
        feedbackMode = false;
        const step = currentMission.steps[currentStepIndex];
        const container = document.getElementById('question-container');
        const opts = document.getElementById('options-container');
        const feedback = document.getElementById('feedback-area');
        
        feedback.innerHTML = '';
        document.getElementById('score-tracker').innerText = `STEP ${currentStepIndex + 1} OF ${currentMission.steps.length}`;
        document.getElementById('next-btn').innerText = "SUBMIT ANSWER";
        document.getElementById('next-btn').className = "action-btn";

        container.innerHTML = `
            <div class="step-badge">STEP ${currentStepIndex + 1}: ${step.type.replace('_', ' ')}</div>
            <div class="question-text">${step.prompt}</div>
        `;

        if (step.type === 'extended_sata') {
            opts.innerHTML = `
                <div class="list-group">
                    ${step.options.map(o => `
                        <label class="list-group-item list-group-item-action p-3">
                            <input class="form-check-input me-3" type="checkbox" name="mission-opt" value="${o}">
                            ${o}
                        </label>
                    `).join('')}
                </div>
            `;
        } else if (step.type === 'matrix') {
            opts.innerHTML = `
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th>Finding</th>
                            ${step.columns.map(c => `<th>${c}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${step.rows.map(r => `
                            <tr>
                                <td>${r}</td>
                                ${step.columns.map(c => `
                                    <td class="radio-cell">
                                        <input type="radio" name="row-${r}" value="${c}" class="form-check-input">
                                    </td>
                                `).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else if (step.type === 'bowtie') {
            opts.innerHTML = `
                <div class="bowtie-container">
                    <div class="bowtie-wing">
                        <div class="bowtie-label">Actions to Take (2)</div>
                        ${step.left_actions.options.map(o => `
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="bowtie-left" value="${o}">
                                <label class="form-check-label small">${o}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bowtie-center">
                        <div class="bowtie-label">Diagnosis</div>
                        <select class="form-select form-select-sm" id="bowtie-center">
                            <option value="">Select Condition...</option>
                            ${step.center_condition.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                        </select>
                    </div>
                    <div class="bowtie-wing">
                        <div class="bowtie-label">Monitor (2)</div>
                        ${step.right_monitor.options.map(o => `
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="bowtie-right" value="${o}">
                                <label class="form-check-label small">${o}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }

    function handleStepAction() {
        if (!feedbackMode) {
            evaluateAnswer();
        } else {
            if (currentStepIndex < currentMission.steps.length - 1) {
                currentStepIndex++;
                renderStep();
            } else {
                alert("Mission Complete! Returning to Menu.");
                // Future: location.href = "menu.html";
            }
        }
    }

    function evaluateAnswer() {
        const step = currentMission.steps[currentStepIndex];
        let isCorrect = false;
        let userFeedback = "";

        if (step.type === 'extended_sata') {
            const selected = Array.from(document.querySelectorAll('input[name="mission-opt"]:checked')).map(i => i.value);
            isCorrect = selected.length === step.answer.length && selected.every(v => step.answer.includes(v));
            userFeedback = step.rationale || "Check clinical indicators against lab values.";
        } else if (step.type === 'matrix') {
            isCorrect = true;
            step.rows.forEach(r => {
                const sel = document.querySelector(`input[name="row-${r}"]:checked`)?.value;
                if (sel !== step.answer[r]) isCorrect = false;
            });
            userFeedback = "Analyze symptoms relative to mechanism of action.";
        } else if (step.type === 'bowtie') {
            const diag = document.getElementById('bowtie-center').value;
            const left = Array.from(document.querySelectorAll('input[name="bowtie-left"]:checked')).map(i => i.value);
            const right = Array.from(document.querySelectorAll('input[name="bowtie-right"]:checked')).map(i => i.value);
            
            isCorrect = diag === step.center_condition.answer && 
                        left.length === 2 && left.every(v => step.left_actions.answer.includes(v)) &&
                        right.length === 2 && right.every(v => step.right_monitor.answer.includes(v));
            userFeedback = "The bowtie requires alignment of diagnosis, intervention, and assessment.";
        }

        const feedbackArea = document.getElementById('feedback-area');
        feedbackArea.innerHTML = `
            <div class="feedback-box ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                <h5 class="fw-bold ${isCorrect ? 'text-success' : 'text-danger'}">
                    <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i>
                    ${isCorrect ? 'CORRECT' : 'INCORRECT'}
                </h5>
                <p class="mb-0 text-white opacity-75">${userFeedback}</p>
            </div>
        `;

        feedbackMode = true;
        document.getElementById('next-btn').innerText = (currentStepIndex === currentMission.steps.length - 1) ? "FINISH MISSION" : "NEXT STEP";
        document.getElementById('next-btn').className = "btn btn-accent btn-lg px-5 fw-bold";
    }
</script>
</body>
</html>
