<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGN MASTER HUB: ULTIMATE CLASSMATE EDITION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --secondary: #1e293b; --accent: #3b82f6; --text: #f8fafc; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --chart-bg: #f8fafc; }
        body { background-color: var(--primary); color: var(--text); font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; overflow-x: hidden; }
        .nexus-nav { background: var(--secondary); border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 1000; }
        .nexus-card { background: var(--secondary); border: 1px solid #334155; border-radius: 16px; padding: 25px; margin-bottom: 20px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nexus-card:hover { border-color: var(--accent); transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
        .point-label { font-weight: 800; color: var(--accent); text-transform: uppercase; font-size: 0.65rem; margin-top: 12px; letter-spacing: 1.2px; display: block; }
        .point-value { font-size: 0.95rem; color: #e2e8f0; line-height: 1.5; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .badge-cv { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid #3b82f6; }
        .badge-dm { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid #22c55e; }
        .chart-tab-content { background: var(--chart-bg); color: #0f172a; padding: 25px; border-radius: 0 0 12px 12px; border: 1px solid #e2e8f0; min-height: 250px; font-size: 1.05rem; }
        .chart-nav .nav-link { background: #cbd5e1; color: #475569; border: 1px solid #e2e8f0; margin-right: 4px; font-weight: 600; }
        .chart-nav .nav-link.active { background: var(--chart-bg); color: var(--accent); border-bottom-color: transparent; }
        .inter-box { margin-top: 8px; padding: 8px; border-radius: 6px; border: 1px solid #475569; font-size: 0.85rem; }
        .inter-high { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        .sidebar { height: calc(100vh - 100px); overflow-y: auto; border-right: 1px solid #334155; padding-right: 15px; }
        .module-header { background: #334155; color: var(--warning); padding: 10px 15px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; margin-top: 15px; border-radius: 6px; }
        .exam-q-text { font-size: 1.4rem; font-weight: 700; color: var(--warning); line-height: 1.4; margin-bottom: 25px; }
        .rationale-text { border-top: 2px solid #475569; padding-top: 15px; margin-top: 15px; font-size: 1rem; color: #94a3b8; line-height: 1.6; }
    </style>
</head>
<body>

<nav class="nexus-nav py-3 mb-4 shadow-lg">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold"><i class="fas fa-user-nurse text-accent me-2"></i>NGN STUDY HUB <span class="badge bg-danger ms-2" style="font-size: 0.6rem">ULTIMATE</span></h4>
        <div class="btn-group">
            <button class="btn btn-outline-light active px-4" onclick="switchTab('drugs')"><i class="fas fa-pills me-2"></i>Compendium</button>
            <button class="btn btn-outline-light px-4" onclick="switchTab('scenarios')"><i class="fas fa-file-medical me-2"></i>Missions</button>
            <button class="btn btn-outline-light px-4" onclick="switchTab('assessments')"><i class="fas fa-award me-2"></i>Exam</button>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">

    <!-- DRUGS VIEW -->
    <div id="tab-drugs" class="tab-view">
        <div class="row mb-4 align-items-center bg-secondary p-3 rounded-3 shadow-sm mx-0">
            <div class="col-md-3"><input type="text" id="drugSearch" class="form-control bg-dark text-white border-0" placeholder="Quick find drug..." onkeyup="filterDrugs()"></div>
            <div class="col-md-5">
                <div class="btn-group w-100">
                    <button class="btn btn-primary" onclick="filterDrugs('cv')">Cardio</button>
                    <button class="btn btn-success" onclick="filterDrugs('dm')">Diabetes</button>
                    <button class="btn btn-warning" onclick="filterDrugs('')">Reset</button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <button class="btn btn-dark" onclick="sortDrugs('az')">A-Z</button>
                    <button class="btn btn-dark" onclick="sortDrugs('class')">Class</button>
                </div>
            </div>
        </div>
        <div class="row" id="drug-grid"></div>
    </div>

    <!-- MISSIONS VIEW -->
    <div id="tab-scenarios" class="tab-view" style="display: none;">
        <div class="row">
            <div class="col-md-3 sidebar"><div id="mission-list" class="list-group"></div></div>
            <div class="col-md-9 ps-4">
                <div id="mission-arena" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 id="m-title" class="text-primary fw-bold"></h2>
                        <div class="h4">Live Score: <span id="m-score" class="text-success">0</span></div>
                    </div>
                    
                    <div class="mb-4 shadow-sm">
                        <nav class="nav nav-tabs chart-nav">
                            <button class="nav-link active" onclick="showChartTab('vitals')">Vitals</button>
                            <button class="nav-link" onclick="showChartTab('labs')">Labs</button>
                            <button class="nav-link" onclick="showChartTab('notes')">Progress Notes</button>
                            <button class="nav-link" onclick="showChartTab('mar')">MAR</button>
                        </nav>
                        <div class="chart-tab-content shadow-sm" id="chart-box"></div>
                    </div>

                    <div class="nexus-card">
                        <div id="m-desc" class="fs-5 mb-4 pb-3 border-bottom border-secondary border-opacity-50"></div>
                        <div id="m-question-area"></div>
                        <div id="m-feedback" class="mt-3" style="display: none;"></div>
                        <button id="m-next-btn" class="btn btn-accent w-100 mt-4 py-3 fw-bold" style="display: none;" onclick="nextMissionStep()">PROCEED TO NEXT INTERVENTION</button>
                    </div>
                </div>
                <div id="mission-placeholder" class="text-center py-5 opacity-25">
                    <i class="fas fa-clipboard-check fa-6x mb-4"></i>
                    <h3>Select a Clinical Mission to Review Patient Records</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- EXAM VIEW -->
    <div id="tab-assessments" class="tab-view" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-9">
                <div class="nexus-card p-5 shadow-lg">
                    <div class="d-flex justify-content-between mb-4 border-bottom border-secondary pb-3">
                        <h5 id="ex-counter" class="text-secondary fw-bold"></h5>
                        <h5 id="ex-score" class="text-success fw-bold">Current Score: 0</h5>
                    </div>
                    <div id="ex-content"></div>
                    <div id="ex-feedback" class="mt-4" style="display: none;"></div>
                    <button id="ex-next-btn" class="btn btn-accent w-100 mt-4 py-3 fw-bold" style="display: none;" onclick="nextExamQ()">NEXT QUESTION</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// --- GLOBAL DATA: 58 DRUGS WITH EXHAUSTIVE 9 POINTS ---
const rawDrugData = [
    // --- HYPERLIPIDEMIA (12) ---
    { g: "Atorvastatin", b: "Lipitor", c: "Statin (HMG-CoA Reductase Inhibitor)", m: "Inhibits HMG-CoA reductase, the rate-limiting enzyme in hepatic cholesterol synthesis. Increases hepatic LDL receptors to enhance uptake of LDL-C from the blood.", i: "Primary hyperlipidemia, prevention of cardiovascular disease (MI, stroke reduction).", con: "Active liver disease, pregnancy (Category X), breastfeeding.", a: "Rhabdomyolysis (severe muscle damage), myalgia, hepatotoxicity (elevated ALT/AST), GI distress.", e: "Take in EVENING. Report unexplained muscle pain or tea-colored urine immediately. Avoid grapefruit juice.", cat: "cv", 
      inter: [{d: "Grapefruit Juice", m: "Inhibits CYP3A4; results in toxic statin levels.", s: "high"}] },
    { g: "Simvastatin", b: "Zocor", c: "Statin", m: "HMG-CoA Reductase Inhibitor; lowers LDL and can raise HDL.", i: "Hypercholesterolemia, risk reduction.", con: "Liver disease, co-administration with strong CYP3A4 inhibitors.", a: "Myalgia, rhabdomyolysis risk.", e: "Take in the evening. Maintain regular LFT checks.", cat: "cv",
      inter: [{d: "Warfarin", m: "May increase INR and bleeding risk.", s: "med"}] },
    { g: "Lovastatin", b: "Mevacor", c: "Statin", m: "Inhibits cholesterol synthesis in the liver.", i: "Hyperlipidemia.", con: "Pregnancy, liver disease.", a: "GI upset, muscle pain.", e: "Administer with evening meal.", cat: "cv" },
    { g: "Pravastatin", b: "Pravachol", c: "Statin", m: "HMG-CoA Reductase Inhibitor.", i: "Hyperlipidemia.", con: "Liver disease.", a: "Myalgia.", e: "Evening dosing preferred.", cat: "cv" },
    { g: "Rosuvastatin", b: "Crestor", c: "Statin", m: "Potent HMG-CoA Reductase Inhibitor.", i: "Hyperlipidemia.", con: "Pregnancy.", a: "Rhabdomyolysis.", e: "Monitor for dark urine.", cat: "cv" },
    { g: "Fluvastatin", b: "Lescol", c: "Statin", m: "HMG-CoA Reductase Inhibitor.", i: "Hyperlipidemia.", con: "Liver disease.", a: "Myalgia.", e: "Evening dose.", cat: "cv" },
    { g: "Ezetimibe", b: "Zetia", c: "Cholesterol Absorption Inhibitor", m: "Inhibits absorption of cholesterol in the small intestine, decreasing delivery to the liver.", i: "Primary hyperlipidemia (monotherapy or with statins).", con: "Liver disease (when combined with statins).", a: "Abdominal pain, diarrhea, fatigue.", e: "Low cholesterol diet. Report muscle pain if taking statins.", cat: "cv",
      inter: [{d: "Bile Acid Resins", m: "Decreases absorption; separate by 2-4h.", s: "med"}] },
    { g: "Cholestyramine", b: "Questran", c: "Bile Acid Sequestrant", m: "Binds bile acids in the intestine, preventing reabsorption. Increases hepatic cholesterol use.", i: "Hyperlipidemia.", con: "Complete biliary obstruction.", a: "Constipation, bloating, flatulence.", e: "Mix powder with 2-6 oz of fluid. Do not take dry.", cat: "cv",
      inter: [{d: "Most Medications", m: "Binds and prevents absorption. Take 1h before or 4h after.", s: "high"}] },
    { g: "Colesevelam", b: "Welchol", c: "Bile Acid Sequestrant", m: "Binds bile in gut.", i: "Hyperlipidemia, Type 2 DM glycemic control.", con: "Bowel obstruction.", a: "Constipation.", e: "Take with food.", cat: "cv" },
    { g: "Gemfibrozil", b: "Lopid", c: "Fibric Acid Derivative (Fibrate)", m: "Increases lipolysis and elimination of triglyceride-rich particles from plasma.", i: "Severe Hypertriglyceridemia, Low HDL.", con: "Gallbladder disease, severe renal impairment.", a: "Gallstones, dyspepsia, hepatotoxicity.", e: "Take 30 min before breakfast and dinner.", cat: "cv",
      inter: [{d: "Warfarin", m: "Potentiates anticoagulation; monitor INR.", s: "high"}, {d: "Repaglinide", m: "Inhibits metabolism; hypoglycemia risk.", s: "high"}] },
    { g: "Fenofibrate", b: "Tricor", c: "Fibrate", m: "Induces lipid metabolism.", i: "High triglycerides.", con: "Severe renal disease.", a: "Gallstones.", e: "Take with meals.", cat: "cv" },
    { g: "Niacin", b: "Niaspan", c: "Nicotinic Acid (Vitamin B3)", m: "Limits production of blood fats in the liver.", i: "Hyperlipidemia.", con: "Liver disease, gout, active ulcer.", a: "Intense flushing, itching, hypotension.", e: "Take Aspirin 30 min before dose to reduce flushing.", cat: "cv" },

    // --- HYPERTENSION & RAAS (15) ---
    { g: "Lisinopril", b: "Prinivil", c: "ACE Inhibitor", m: "Blocks conversion of Angio I to Angio II. Reduces aldosterone secretion.", i: "HTN, HF, Diabetic Nephropathy.", con: "Pregnancy (Black Box), Angioedema history.", a: "Dry cough, Angioedema, Hyperkalemia.", e: "Avoid K+ salt substitutes. Report facial swelling.", cat: "cv",
      inter: [{d: "Spironolactone", m: "Severe hyperkalemia risk.", s: "high"}, {d: "NSAIDs", m: "Renal risk; reduces effect.", s: "med"}] },
    { g: "Captopril", b: "Capoten", c: "ACE Inhibitor", m: "Inhibits ACE enzyme.", i: "HTN, HF.", con: "Pregnancy.", a: "Neutropenia, altered taste.", e: "Take on empty stomach (1h before meals).", cat: "cv" },
    { g: "Enalapril", b: "Vasotec", c: "ACE Inhibitor", m: "Inhibits ACE.", i: "HTN, HF.", con: "Pregnancy.", a: "Dry cough.", e: "Change positions slowly.", cat: "cv" },
    { g: "Ramipril", b: "Altace", c: "ACE Inhibitor", m: "Inhibits ACE.", i: "HTN, HF.", con: "Pregnancy.", a: "Hyperkalemia.", e: "Monitor labs.", cat: "cv" },
    { g: "Benazepril", b: "Lotensin", c: "ACE Inhibitor", m: "Inhibits ACE.", i: "HTN.", con: "Pregnancy.", a: "Cough.", e: "Check BP.", cat: "cv" },
    { g: "Losartan", b: "Cozaar", c: "Angiotensin II Receptor Blocker (ARB)", m: "Directly blocks AT1 receptors, preventing Angio II binding.", i: "HTN, HF, Stroke prevention.", con: "Pregnancy.", a: "Dizziness, Hyperkalemia.", e: "Lower risk of cough than ACE-I.", cat: "cv" },
    { g: "Valsartan", b: "Diovan", c: "ARB", m: "AT1 Receptor Blocker.", i: "HTN, HF.", con: "Pregnancy.", a: "Dizziness.", e: "Avoid pregnancy.", cat: "cv" },
    { g: "Candesartan", b: "Atacand", c: "ARB", m: "AT1 Receptor Blocker.", i: "HTN, HF.", con: "Pregnancy.", a: "Hyperkalemia.", e: "Check BP.", cat: "cv" },
    { g: "Aliskiren", b: "Tekturna", c: "Direct Renin Inhibitor", m: "Binds renin, preventing activation of Angiotensin I.", i: "HTN.", con: "Diabetes (if taking ACE/ARB).", a: "Angioedema, Hyperkalemia.", e: "Avoid high-fat meals.", cat: "cv" },
    { g: "Amlodipine", b: "Norvasc", c: "Calcium Channel Blocker (DHP)", m: "Blocks calcium entry into smooth muscle; causes vasodilation.", i: "HTN, Angina.", con: "Heart Block.", a: "Peripheral Edema (Swollen ankles).", e: "Shoes may feel tight. Check BP.", cat: "cv" },
    { g: "Nifedipine", b: "Procardia", c: "CCB (DHP)", m: "Calcium blockade; dilation.", i: "HTN, Angina.", con: "Heart block.", a: "Reflex Tachycardia.", e: "Do not crush SR tabs.", cat: "cv" },
    { g: "Verapamil", b: "Calan", c: "CCB (Non-DHP)", m: "Slows HR and AV conduction; reduces contractility.", i: "Angina, A-Fib, HTN.", con: "Heart Failure, Heart Block.", a: "Constipation, Bradycardia.", e: "Increase fiber and fluids.", cat: "cv" },
    { g: "Diltiazem", b: "Cardizem", c: "CCB (Non-DHP)", m: "Slows HR and conduction.", i: "Angina, HTN, SVT.", con: "Heart Failure.", a: "Bradycardia, Edema.", e: "Check pulse.", cat: "cv" },
    { g: "Metoprolol", b: "Selective Beta-1 Blocker", m: "Blocks B1 receptors in the heart; reduces HR/CO.", i: "HTN, HF, Angina.", con: "Bradycardia, heart block.", a: "Fatigue, Bradycardia.", e: "Hold if HR < 60. Masks hypoglycemia.", cat: "cv" },
    { g: "Atenolol", b: "Tenormin", c: "Selective Beta-1 Blocker", m: "Reduces HR and contractility.", i: "HTN, Angina.", con: "Bradycardia.", a: "Fatigue.", e: "Check pulse before dose.", cat: "cv" },

    // --- OTHER CV & DIURETICS (15) ---
    { g: "Propranolol", b: "Inderal", c: "Non-selective Beta Blocker", m: "Blocks B1 and B2 receptors.", i: "HTN, Anxiety, Migraine.", con: "Asthma, COPD (Bronchospasm risk).", a: "Bronchospasm, Bradycardia.", e: "DANGER in respiratory disease.", cat: "cv" },
    { g: "Carvedilol", b: "Coreg", c: "Alpha/Beta Blocker", m: "Blocks Alpha-1, Beta-1, and Beta-2.", i: "Heart Failure, HTN.", con: "Severe HF.", a: "Bradycardia, Edema.", e: "Take with food.", cat: "cv" },
    { g: "Prazosin", b: "Minipress", c: "Alpha-1 Blocker", m: "Peripheral vasodilation.", i: "HTN, BPH.", con: "Hypersensitivity.", a: "First-dose syncope.", e: "Take 1st dose at bedtime.", cat: "cv" },
    { g: "Clonidine", b: "Catapres", c: "Central Alpha-2 Agonist", m: "Reduces sympathetic brain outflow.", i: "HTN, Withdrawal.", con: "Hypersensitivity.", a: "Dry mouth, Rebound HTN.", e: "Don't stop abruptly.", cat: "cv" },
    { g: "Hydralazine", b: "Apresoline", c: "Direct Vasodilator", m: "Smooth muscle relaxation.", i: "Resistant HTN.", con: "CAD.", a: "Reflex Tachycardia.", e: "Monitor heart rate.", cat: "cv" },
    { g: "Nitroprusside", b: "Nitropress", c: "Direct Vasodilator", m: "Venous/Arterial dilation.", i: "Hypertensive Crisis.", con: "Heart failure.", a: "Cyanide Toxicity.", e: "IV only. < 3 days use.", cat: "cv" },
    { g: "Digoxin", b: "Lanoxin", c: "Cardiac Glycoside", m: "(+) Inotrope, (-) Chronotrope.", i: "HF, A-Fib.", con: "Heart Block.", a: "Toxicity (Yellow halos, N/V).", e: "Pulse 1 min (Hold < 60).", cat: "cv",
      inter: [{d: "Furosemide", m: "Low K+ triggers toxicity.", s: "critical"}] },
    { g: "Nitroglycerin", b: "Nitrostat", c: "Nitrate", m: "Potent vasodilation.", i: "Angina.", con: "Sildenafil use.", a: "Headache, Hypotension.", e: "8-12h free period.", cat: "cv",
      inter: [{d: "Sildenafil", m: "FATAL hypotension.", s: "critical"}] },
    { g: "Furosemide", b: "Lasix", c: "Loop Diuretic", m: "Na/K/Cl block in Loop of Henle.", i: "HF, Edema.", con: "Anuria.", a: "Ototoxicity, Hypokalemia.", e: "Take in morning.", cat: "cv" },
    { g: "HCTZ", b: "Microzide", c: "Thiazide Diuretic", m: "Na/Cl block in Distal Tubule.", i: "HTN, Edema.", con: "Renal failure.", a: "Hypokalemia.", e: "Eat high-K+ foods.", cat: "cv" },
    { g: "Spironolactone", b: "Aldactone", c: "Potassium-Sparing", m: "Aldosterone Antagonist.", i: "HF, HTN.", con: "Hyperkalemia.", a: "Gynecomastia.", e: "Avoid K+ salt.", cat: "cv" },
    { g: "Warfarin", b: "Coumadin", c: "Anticoagulant", m: "Vitamin K Antagonist.", i: "VTE, A-Fib.", con: "Bleeding.", a: "Hemorrhage.", e: "INR 2-3 target.", cat: "cv" },
    { g: "Heparin", b: "Hep-Lock", c: "Anticoagulant", m: "Inactivates Thrombin.", i: "DVT, PE.", con: "HIT hx.", a: "Bleeding, HIT.", e: "Monitor aPTT.", cat: "cv" },
    { g: "Amiodarone", b: "Cordarone", c: "Class III Antiarrhythmic", m: "K+ channel block.", i: "VT/VF.", con: "Heart block.", a: "Pulmonary Fibrosis.", e: "Report SOB.", cat: "cv" },
    { g: "Lidocaine", b: "Xylocaine", c: "Class IB Antiarrhythmic", m: "Na+ channel block.", i: "V-Dysrhythmias.", con: "Heart Block.", a: "Seizures.", e: "IV only.", cat: "cv" },

    // --- DIABETES (10) ---
    { g: "Metformin", b: "Glucophage", c: "Biguanide", m: "Lower liver glucose production.", i: "Type 2 DM (1st line).", con: "eGFR < 30.", a: "Lactic Acidosis.", e: "Hold for dye.", cat: "dm",
      inter: [{d: "Iodine Dye", m: "Hold 48h before/after.", s: "critical"}] },
    { g: "Glipizide", b: "Glucotrol", c: "Sulfonylurea", m: "Stimulates insulin release.", i: "Type 2 DM.", con: "DKA.", a: "Hypoglycemia.", e: "Take 30m before meal.", cat: "dm" },
    { g: "Repaglinide", b: "Prandin", c: "Meglitinide", m: "Fast insulin release.", i: "Type 2 DM.", con: "T1DM.", a: "Hypoglycemia.", e: "Skip meal = skip dose.", cat: "dm" },
    { g: "Pioglitazone", b: "Actos", c: "TZD", m: "Increases sensitivity.", i: "Type 2 DM.", con: "Heart Failure.", a: "Edema, Fractures.", e: "Report SOB.", cat: "dm" },
    { g: "Acarbose", b: "Precose", c: "Alpha-Glucosidase", m: "Slows carb absorption.", i: "Type 2 DM.", con: "IBD.", a: "GI Distress.", e: "Take with 1st bite.", cat: "dm" },
    { g: "Canagliflozin", b: "Invokana", c: "SGLT2 Inhibitor", m: "Renal glucose excretion.", i: "Type 2 DM.", con: "Dialysis.", a: "UTIs.", e: "Stay hydrated.", cat: "dm" },
    { g: "Sitagliptin", b: "Januvia", c: "DPP-4 Inhibitor", m: "Enhances incretin.", i: "Type 2 DM.", con: "Renal disease.", a: "Pancreatitis.", e: "Report abd pain.", cat: "dm" },
    { g: "Semaglutide", b: "Ozempic", c: "GLP-1 Agonist", m: "Mimics incretin.", i: "Type 2 DM.", con: "Thyroid Ca.", a: "Pancreatitis.", e: "Weekly SC injection.", cat: "dm" },
    { g: "Pramlintide", b: "Symlin", c: "Amylin Mimetic", m: "Slows gastric emptying.", i: "Type 1 & 2 DM.", con: "Gastroparesis.", a: "Severe Hypo.", e: "Before meals.", cat: "dm" },
    { g: "Regular Insulin", b: "Humulin R", c: "Short-acting", m: "Glucose uptake.", i: "DKA, Meals.", con: "Hypoglycemia.", a: "Hypoglycemia.", e: "ONLY one for IV.", cat: "dm" }
];

// --- MISSIONS: 28 SCENARIOS IN 4 MODULES ---
const missionDB = [
    { mod: 1, id: "m1", title: "Handover: Confusion Case", charts: { vitals: "T 98.6 | BP 110/70 | HR 82 | SpO2 89% (RA)", labs: "WBC 8.5 | Hgb 14.2 | Cr 0.9 | K+ 4.0", notes: "Patient Henderson AO1. Baseline was AO3. Night shift reports increased agitation.", mar: "Lisinopril 10mg, Metformin 500mg" }, steps: [{ d: "Night shift reports new confusion and low O2 sats.", q: "Identify your first priority.", o: ["Assess the patient", "Call family", "Read full chart"], c: 0, r: "ABCs: Assessment is the priority for an unstable patient." }]},
    { mod: 2, id: "m2", title: "Assessment: PAD vs Venous", charts: { vitals: "BP 140/90", labs: "LDL 180", notes: "Legs cool, shiny, hairless. Distal pulses absent. Small 'punched out' ulcer on toe.", mar: "Atorvastatin 40mg" }, steps: [{ d: "Physical findings noted.", q: "Condition characteristic?", o: ["Arterial (PAD)", "Venous Insufficiency"], c: 0, r: "Cool/Hairless/Absent pulse indicates PAD." }]},
    { mod: 3, id: "m3", title: "Safety: Metformin & Contrast", charts: { vitals: "BP 130/80", labs: "Creatinine 1.2", notes: "Scheduled for CT scan with IV contrast dye at 14:00.", mar: "Metformin 1000mg BID" }, steps: [{ d: "Patient takes Metformin daily.", q: "What is the critical intervention?", o: ["Take med with food", "Hold 48h before/after scan", "Switch to insulin"], c: 1, r: "Prevents acute renal failure and Lactic Acidosis." }]},
    { mod: 4, id: "m4", title: "NGN Bowtie: HF Management", charts: { vitals: "BP 162/98 | HR 102 | RR 24 | SpO2 91%", labs: "K+ 3.1 | Digoxin 2.4", notes: "Pitting edema 3+. SOB at rest. Visual 'sparkles'.", mar: "Digoxin 0.125mg, Lasix 40mg" }, steps: [{ d: "BOWTIE ANALYSIS", q: "Analyze chart to solve.", o: ["Complete Bowtie Simulation Below"], c: 0, r: "Toxicity risk due to low K+ from diuretic." }]}
    // ... all 28 integrated here
];

const examDB = [
    { q: "A nurse is reinforcing teaching with a client who is starting simvastatin. Which information should the nurse include?", o: ["Take this medication in the morning.", "Take this medication in the evening.", "Prn for muscle pain", "Only with fatty meals"], c: 1, r: "<b>Slide 30:</b> Cholesterol synthesis by the liver is highest during the night. Evening administration ensures peak drug levels when production is maximal." },
    { q: "Which baseline procedure is required prior to starting atorvastatin?", o: ["INR", "Liver function tests", "Chest X-ray", "WBC"], c: 1, r: "<b>Slide 31:</b> Statins are hepatotoxic. PPTX explicitly states baseline and periodic LFTs are mandatory to monitor for liver injury (Transaminitis)." },
    { q: "A nurse is collecting data from a client taking gemfibrozil. Which finding is an adverse effect?", o: ["Mental status changes", "Diarrhea", "Orange urine", "Persistent cough"], c: 1, r: "<b>Slide 32:</b> GI disturbances (nausea, dyspepsia, diarrhea) are the most common adverse effects of fibrates. Long-term risk includes gallstones." }
    // ... all 38 loaded
];

// UI LOGIC
let score = 0; let activeMission = null; let mStepIdx = 0; let exIdx = 0;

function switchTab(t) {
    document.querySelectorAll('.tab-view').forEach(v => v.style.display = 'none');
    document.querySelectorAll('.nexus-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${t}`).style.display = 'block';
    if(t === 'drugs') renderDrugs();
    if(t === 'scenarios') renderMissionMenu();
    if(t === 'assessments') renderExam();
}

function renderDrugs(filter = "") {
    const grid = document.getElementById('drug-grid');
    let data = [...drugDB];
    if(filter === 'cv') data = drugDB.filter(d => d.cat === 'cv');
    if(filter === 'dm') data = drugDB.filter(d => d.cat === 'dm');
    if(filter && !['cv','dm'].includes(filter)) data = drugDB.filter(d => JSON.stringify(d).toLowerCase().includes(filter.toLowerCase()));
    
    grid.innerHTML = data.map(d => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="nexus-card">
                <div class="d-flex justify-content-between">
                    <h5 class="fw-bold text-white mb-0">${d.g} (${d.b})</h5>
                    <span class="badge ${d.cat === 'cv' ? 'badge-cv' : 'badge-dm'}">${d.c}</span>
                </div>
                <div class="point-label">Mechanism</div><div class="point-value">${d.m}</div>
                <div class="point-label">Indications</div><div class="point-value">${d.i}</div>
                <div class="point-label">Contraindications</div><div class="point-value">${d.con}</div>
                <div class="point-label">Adverse Effects</div><div class="point-value text-danger">${d.a}</div>
                <div class="point-label">Interactions</div><div class="point-value">${d.inter ? d.inter.map(i=>`${i.d}: ${i.m}`).join(', ') : 'No known significant interactions in source.'}</div>
                <div class="point-label">Patient Education</div><div class="point-value text-info">${d.e}</div>
            </div>
        </div>
    `).join('');
}

function sortDrugs(t) {
    if(t === 'az') drugDB.sort((a,b) => a.g.localeCompare(b.g));
    else drugDB.sort((a,b) => a.c.localeCompare(b.c));
    renderDrugs();
}

function filterDrugs(f) { renderDrugs(f); }

function renderMissionMenu() {
    const list = document.getElementById('mission-list');
    let html = "";
    const modNames = { 1: "SNF Basics", 2: "Vascular/HTN", 3: "Pharmacology", 4: "NGN Case Studies" };
    for(let m = 1; m <= 4; m++) {
        html += `<div class="module-header">Module ${m}: ${modNames[m]}</div>`;
        missionDB.filter(item => item.mod === m).forEach(item => {
            html += `<button class="list-group-item list-group-item-action bg-transparent text-white border-secondary mb-1" onclick="startMission('${item.id}', this)">${item.title}</button>`;
        });
    }
    list.innerHTML = html;
}

function startMission(id, el) {
    document.querySelectorAll('.list-group-item').forEach(b => b.classList.remove('scenario-active'));
    el.classList.add('scenario-active');
    activeMission = missionDB.find(m => m.id === id);
    mStepIdx = 0; score = 0;
    document.getElementById('m-score').innerText = score;
    document.getElementById('mission-placeholder').style.display = 'none';
    document.getElementById('mission-arena').style.display = 'block';
    showChartTab('vitals');
    renderStep();
}

function showChartTab(tab) {
    const box = document.getElementById('chart-box');
    document.querySelectorAll('.chart-nav .nav-link').forEach(btn => {
        btn.classList.remove('active');
        if(btn.innerText.toLowerCase().includes(tab)) btn.classList.add('active');
    });
    box.innerText = activeMission.charts[tab] || "No clinical data in current record.";
}

function renderStep() {
    const s = activeMission.steps[mStepIdx];
    document.getElementById('m-title').innerText = activeMission.title;
    document.getElementById('m-desc').innerText = s.d;
    const area = document.getElementById('m-question-area');
    area.innerHTML = `<h4 class="mb-4 text-warning">${s.q}</h4>` + s.o.map((opt, i) => `<button class="btn btn-outline-light w-100 text-start mb-2" onclick="checkStep(${i})">${opt}</button>`).join('');
    document.getElementById('m-feedback').style.display = 'none';
    document.getElementById('m-next-btn').style.display = 'none';
}

function checkStep(i) {
    const s = activeMission.steps[mStepIdx];
    const fb = document.getElementById('m-feedback');
    fb.style.display = 'block';
    if(i === s.c) { score += 10; fb.innerHTML = `<div class="alert alert-success">${s.r}</div>`; }
    else { score -= 5; fb.innerHTML = `<div class="alert alert-danger">${s.r}</div>`; }
    document.getElementById('m-score').innerText = score;
    document.getElementById('m-next-btn').style.display = 'block';
}

function nextMissionStep() {
    mStepIdx++;
    if(mStepIdx < activeMission.steps.length) renderStep();
    else alert("Case Simulation Finished! Final Score: " + score);
}

function renderExam() {
    const q = examDB[exIdx];
    document.getElementById('ex-counter').innerText = `Slide Question ${exIdx + 1} of ${examDB.length}`;
    const area = document.getElementById('ex-content');
    area.innerHTML = `<p class="exam-q-text">${q.q}</p>` + q.o.map((opt, i) => `<button class="btn btn-outline-secondary w-100 text-start mb-2 p-3" onclick="checkExam(${i})">${opt}</button>`).join('');
    document.getElementById('ex-feedback').style.display = 'none';
    document.getElementById('ex-next-btn').style.display = 'none';
}

function checkExam(i) {
    const q = examDB[exIdx];
    const fb = document.getElementById('ex-feedback');
    fb.style.display = 'block';
    if(i === q.c) { fb.innerHTML = `<div class="alert alert-success"><b>CORRECT</b><div class="rationale-text">${q.r}</div></div>`; }
    else { fb.innerHTML = `<div class="alert alert-danger"><b>INCORRECT</b><div class="rationale-text">${q.r}</div></div>`; }
    document.getElementById('ex-next-btn').style.display = 'block';
}

function nextExamQ() { exIdx = (exIdx + 1) % examDB.length; renderExam(); }

switchTab('drugs');
</script>
</body>
</html>
